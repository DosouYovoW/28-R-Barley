---
title: "Untitled"
format: html
editor: visual
---

# Lodging

## Mixed modeling

```{r}
# Set a random seed for reproducibility
set.seed(123)

# Fit the mixed model with year & location as random effects
reg_mod_height <- lmer(lodging_index_2 ~ cultivar + pgr_trt_name + 
                (1 | year) + (1 | location), 
                data = data %>% mutate(pgr_trt_name = fct_relevel(pgr_trt_name, "No_PGR"),
                                       cultivar = fct_relevel(cultivar, "CDC_Austenson")))

# Extract fixed effects with p-values
fixed_effects <- broom.mixed::tidy(reg_mod_height, effects = "fixed") %>%
  filter(term != "(Intercept)")

# Extract confidence intervals for fixed effects
conf_int <- confint(reg_mod_height, method = "Wald") %>%  # Compute 95% CIs
  as.data.frame() %>%
  rownames_to_column("term") %>%
  filter(term %in% fixed_effects$term) %>%
  rename(ci_lower = `2.5 %`, ci_upper = `97.5 %`)

# Merge CIs with fixed effects
fixed_effects <- fixed_effects %>%
  left_join(conf_int, by = "term") %>%
  mutate(
    p_signif = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE ~ ""
    )
  )

# Extract random effects (variance components) - No p-values here
random_effects <- broom.mixed::tidy(reg_mod_height, effects = "ran_pars") %>%
  select(-term) %>% 
  rename(term = group) %>% 
  mutate(
    term = str_replace(term, "sd__", ""),  # Clean term names
    effect = "Random",
    p_signif = "",  # No p-values for random effects
    ci_lower = NA,  # No CIs for random effects
    ci_upper = NA
  )

# Combine fixed and random effects
model_results <- bind_rows(fixed_effects, random_effects)

# Assign grouping categories
model_results_height <- model_results %>%
  filter(term != "Residual") %>%
  mutate(category = case_when(
    grepl("location", term) ~ "Location",
    grepl("year", term) ~ "Year",
    grepl("cultivar", term) ~ "Cultivar",
    grepl("pgr_trt_name", term) ~ "PGR Treatment",
    TRUE ~ "Other"
  )) %>% 
  mutate(category = fct_relevel(category, "Location", "Year"),  # Convert to factor for correct order
         significant_or_not = case_when(p.value < 0.05 ~ "Significant",
                                        p.value >= 0.05 ~ "Not Significant",
                                        .default = "other"
           
         )) %>% 
  mutate(term = case_when(
    grepl("CDC_Austenson", term) ~ "CDC Austenson",
    grepl("cultivarAB_Hague", term) ~ "AB Hague",
    grepl("Esma", term) ~ "Esma",
   # grepl("TR18647", term) ~ "TR18647",
    grepl("M125_30-32", term) ~ "M125g SE",
    grepl("M125_37", term) ~ "M125g Flag LE + Fungicide",
    term == "pgr_trt_nameM62.5_21-24" ~ "M62.5g ET",
    term == "pgr_trt_nameM62.5_21-24 + M62.5_30-32" ~ "(M62.5g ET + Herbicide) | M62.5g SE",
    term == "pgr_trt_nameM62.5_21-24 + M62.5_37" ~ "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)",
    term == "pgr_trt_nameM62.5_30-32" ~ "M62.5g SE",
    term == "pgr_trt_nameM62.5_30-32 + M62.5_37" ~ "M62.5g SE | (M62.5g FLE + Fungicide)",
    term == "pgr_trt_nameM62.5_37" ~ "M62.5g Flag LE + Fungicide",
    TRUE ~ term
  )) 


```

```{r}
# Define custom order for PGR treatments
custom_order <- c("M62.5g SE | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | M62.5g SE", 
                  "M125g Flag LE + Fungicide",
                  "M125g SE",
                  "M62.5g Flag LE + Fungicide",
                  "M62.5g SE",
                  "M62.5g ET")

# Apply manual order to the "term" column for PGR treatments only
model_results_height <- model_results_height %>%
  mutate(term = fct_relevel(term, custom_order))

# Plot with reordered PGR treatments
ggplot(model_results_height, aes(x = estimate, y = term, shape = effect, color = significant_or_not)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = ci_lower, xmax = ci_upper), height = 0.2) +  # Confidence intervals
  geom_text(aes(label = paste(round(estimate, 2), p_signif)), hjust = 0.9, vjust = -0.8, size = 3, fontface = "bold", show.legend = F) +  # Add estimate & p-value stars
  facet_grid(category ~., scales = "free_y", space = "free_y") +  # Group by category
  geom_vline(xintercept = 0, lwd = 0.2, linetype = "dashed") +  # Vertical line at zero
  scale_shape_manual(values = c(16, 17)) +  # Different shapes for fixed and random effects
  scale_color_manual(values = c("gray60", "gray10", "green4")) +   # Different colors for fixed and random
  labs(title = "", caption = "lodging index Mixed Model Effects with Confidence Intervals",
       x = "Estimated Effect", y = "",
       shape = "Effect Type", color = "P.Value") +
  theme_bw() +
  guides(color = "none") +
  theme(strip.text.y = element_text(angle = 0))

ggsave("figure/lodging/lodging_index_3_modeling.png", width = 8, height = 5, dpi = 600)
```

## Varity per location, Plant height at maturity

```{r}
source("myFunctions.R")

ph1 <- lsd_test_01_mod(data %>% 
                    filter(year == 2024) %>% 
              filter(location == "Vermilion") %>% 
              mutate(treatment = cultivar,
                     outcome = avg_height_at_phys_maturity))+
  coord_cartesian(ylim = c(0,60)) +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Lodging Index", title = "Vermilion")
ph1
ggsave("figure/lodging/plant_heigh_Vermilion_year.png", width = 10, height = 5, dpi = 600)
```

```{r}
source("myFunctions.R")
p_av <- lsd_test_01_mod(data %>% 
            #  filter(location == "Lethbridge") %>% 
              mutate(treatment = cultivar,
                     outcome = avg_height_at_phys_maturity))+
  coord_cartesian(ylim = c(0, 80)) +
  labs(x= "", y = "", title = "Overall Average")+
 theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)
p_av
ggsave("figure/plant_heigh/Overall_Average.png", width = 10, height = 5, dpi = 600)
```

```{r}
data_plant_h <- data %>% 
mutate(pgr_trt_name = case_when(
    pgr_trt_name == "M125_30-32" ~ "M125g SE",
    pgr_trt_name == "M125_37" ~ "M125g Flag LE + Fungicide",
    pgr_trt_name == "M62.5_21-24" ~ "M62.5g ET",
    pgr_trt_name == "M62.5_21-24 + M62.5_30-32" ~ "(M62.5g ET + Herbicide) | M62.5g SE",
    pgr_trt_name == "M62.5_21-24 + M62.5_37" ~ "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)",
    pgr_trt_name == "M62.5_30-32" ~ "M62.5g SE",
    pgr_trt_name == "M62.5_30-32 + M62.5_37" ~ "M62.5g SE | (M62.5g FLE + Fungicide)",
    pgr_trt_name == "M62.5_37" ~ "M62.5g Flag LE + Fungicide",
    .default =  pgr_trt_name
  )) 

reshuffle <- c("M62.5g SE | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)", 
               "(M62.5g ET + Herbicide) | M62.5g SE", 
                  "M125g Flag LE + Fungicide",
                  "M125g SE",
                  "M62.5g Flag LE + Fungicide",
                  "M62.5g SE",
                  "M62.5g ET")
```

```{r}
source("myFunctions.R")
p_Ov <- lsd_test_01(data_plant_h %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = avg_height_at_phys_maturity))+
  ylim(0,100) +
 theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
   labs(x= "", y = "Average Plant Height (cm)", title = "Overall Average")+
  coord_flip()
p_Ov
ggsave("figure/plant_heigh/Overall_trt.png", width = 10, height = 5, dpi = 600)
```

```{r}
p2 <- lsd_test_01_mod(data_plant_h %>% 
              filter(location == "Lethbridge") %>% 
              mutate(treatment = cultivar,
                     outcome = avg_height_at_phys_maturity))+
  coord_cartesian(ylim = c(0,100)) +
  labs(x= "", y = "", title = "Lethbridge")+
 theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5, angle = 15)) +labs(x = NULL, y = NULL)
p2
```

```{r}
p2_1 <- lsd_test_02_mod(data_plant_h %>% 
              filter(location == "Lethbridge") %>% 
              mutate(treatment = factor(year),
                     outcome = avg_height_at_phys_maturity,
                     group = cultivar))+
 # coord_cartesian(ylim = c(0,14000)) +
  labs(x= "", y = "", title = "Lethbridge")+
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Average Plant Height (cm)", title = "Lethbridge", fill = "Variety")
p2_1
ggsave("figure/plant_heigh/plant_heigh_Lethbridge_year.png", width = 10, height = 5, dpi = 600)
```

```{r}
p3 <- lsd_test_01_mod(data_plant_h %>% 
              filter(location == "Falher") %>% 
              mutate(treatment = cultivar,
                     outcome = avg_height_at_phys_maturity))+
  coord_cartesian(ylim = c(0,50))+
  labs(x= "", y = "Average Plant Height (cm)", title = "Falher")+
   theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5, angle = 15)) +labs(x = NULL, y = NULL)
p3
```

```{r}
p3_1 <- lsd_test_02_mod(data_plant_h %>% 
              filter(location == "Falher") %>% 
              mutate(treatment = factor(year),
                     outcome = avg_height_at_phys_maturity,
                     group = cultivar))+
  coord_cartesian(ylim = c(0,70)) +
  labs(x= "", y = "", title = "Falher")+
 theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (kg/ha)", title = "Falher", fill = "Variety")
p3_1
ggsave("figure/plant_heigh/plant_heigh_Falher_year.png", width = 10, height = 5, dpi = 600)
```

```{r}
p1 + p3 + p2
ggsave("figure/plant_heigh/plant_heigh_varietyy_locations.png", width = 8, height = 5, dpi = 600)
```

## Treatments

```{r}
source("myFunctions.R") 
reshuffle <- c("M62.5g SE | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)", 
               "(M62.5g ET + Herbicide) | M62.5g SE", 
                  "M125g Flag LE + Fungicide",
                  "M125g SE",
                  "M62.5g Flag LE + Fungicide",
                  "M62.5g SE",
                  "M62.5g ET")

p4 <- lsd_test_01(data_plant_h %>% 
              filter(location == "Vermilion") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = avg_height_at_phys_maturity))+
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5#, size= 5, angle = 90
    )) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Vermilion")+
  ylim(0,80)+
  coord_flip()
p4
ggsave("figure/plant_heigh/plant_heigh_vermilion_trt.png", width = 8, height = 5, dpi = 600)
```

```{r}
source("myFunctions.R")
reshuffle <- c("M62.5g SE | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)", 
               "(M62.5g ET + Herbicide) | M62.5g SE", 
                  "M125g Flag LE + Fungicide",
                  "M125g SE",
                  "M62.5g Flag LE + Fungicide",
                  "M62.5g SE",
                  "M62.5g ET")

p4_1 <- lsd_test_02(data_plant_h %>% 
              filter(location == "Vermilion") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = avg_height_at_phys_maturity,
                     group = as.factor(year)))+
  ylim(0,100) +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Vermilion", fill = "Year")+
   coord_flip()
p4_1
ggsave("figure/plant_heigh/plant_heigh_vermilion_trt_year.png", width = 10, height = 8, dpi = 600)
```

```{r}
source("myFunctions.R")
p5 <- lsd_test_01(data_plant_h %>% 
              filter(location == "Lethbridge") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = avg_height_at_phys_maturity))+
  ylim(0,100) +
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
    axis.text.x = element_text(vjust = 0.5)) +
  labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Lethbridge")+
   coord_flip()
p5
ggsave("figure/plant_heigh/plant_heigh_lethbridge_trt.png", width = 8, height = 5, dpi = 600)
```

```{r}
p5_1 <- lsd_test_02(data_plant_h %>% 
              filter(location == "Lethbridge") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = avg_height_at_phys_maturity,
                     group = as.factor(year)))+
  ylim(0,140) +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Lethbridge", fill = "Year")+
  coord_flip()
p5_1
ggsave("figure/plant_heigh/plant_heigh_Lethbridge_trt_year.png", width = 10, height = 5, dpi = 600)
```

```{r}
p6 <- lsd_test_01(data_plant_h %>% 
              filter(location == "Falher") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = avg_height_at_phys_maturity))+
   ylim(0,60) +
  coord_flip()+
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Falher")
p6
ggsave("figure/plant_heigh/plant_heigh_falher_trt.png", width = 8, height = 5, dpi = 600)
```

```{r}
p4 + p5 + p6
ggsave("figure/plant_heigh/plant_heigh_all_location.png", width = 10, height = 5, dpi = 600)
```

```{r}
p6_1 <- lsd_test_02(data_plant_h %>% 
              filter(location == "Falher") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = avg_height_at_phys_maturity,
                     group = as.factor(year)))+
  ylim(0,80) +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Falher", fill = "Year")+
  coord_flip()
p6_1
ggsave("figure/plant_heigh/plant_heigh_Falher_trt_year.png", width = 10, height = 5, dpi = 600)
```
