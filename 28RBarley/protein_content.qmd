---
title: "Untitled"
format: html
editor: visual
---


# Grain protein content
## Mixed modeling
```{r}
# Set a random seed for reproducibility
set.seed(123)

# Fit the mixed model with year & location as random effects
reg_mod_height <- lmer(protein_percent_dm ~ cultivar + pgr_trt_name + 
                (1 | year) + (1 | location), 
                data = data %>% mutate(pgr_trt_name = fct_relevel(pgr_trt_name, "No_PGR"),
                                       cultivar = fct_relevel(cultivar, "CDC_Austenson")))

# Extract fixed effects with p-values
fixed_effects <- broom.mixed::tidy(reg_mod_height, effects = "fixed") %>%
  filter(term != "(Intercept)")

# Extract confidence intervals for fixed effects
conf_int <- confint(reg_mod_height, method = "Wald") %>%  # Compute 95% CIs
  as.data.frame() %>%
  rownames_to_column("term") %>%
  filter(term %in% fixed_effects$term) %>%
  rename(ci_lower = `2.5 %`, ci_upper = `97.5 %`)

# Merge CIs with fixed effects
fixed_effects <- fixed_effects %>%
  left_join(conf_int, by = "term") %>%
  mutate(
    p_signif = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE ~ ""
    )
  )

# Extract random effects (variance components) - No p-values here
random_effects <- broom.mixed::tidy(reg_mod_height, effects = "ran_pars") %>%
  select(-term) %>% 
  rename(term = group) %>% 
  mutate(
    term = str_replace(term, "sd__", ""),  # Clean term names
    effect = "Random",
    p_signif = "",  # No p-values for random effects
    ci_lower = NA,  # No CIs for random effects
    ci_upper = NA
  )

# Combine fixed and random effects
model_results <- bind_rows(fixed_effects, random_effects)

# Assign grouping categories
model_results_height <- model_results %>%
  filter(term != "Residual") %>%
  mutate(category = case_when(
    grepl("location", term) ~ "Location",
    grepl("year", term) ~ "Year",
    grepl("cultivar", term) ~ "Cultivar",
    grepl("pgr_trt_name", term) ~ "PGR Treatment",
    TRUE ~ "Other"
  )) %>% 
  mutate(category = fct_relevel(category, "Location", "Year"),  # Convert to factor for correct order
         significant_or_not = case_when(p.value < 0.05 ~ "Significant",
                                        p.value >= 0.05 ~ "Not Significant",
                                        .default = "other"
           
         )) %>% 
   mutate(term = case_when(
    grepl("CDC_Austenson", term) ~ "CDC Austenson",
    grepl("cultivarAB_Hague", term) ~ "AB Hague",
    grepl("Esma", term) ~ "Esma",
   # grepl("TR18647", term) ~ "TR18647",
    grepl("M125_30-32", term) ~ "M125g SE",
    grepl("M125_37", term) ~ "M125g Flag LE + Fungicide",
    term == "pgr_trt_nameM62.5_21-24" ~ "M62.5g ET",
    term == "pgr_trt_nameM62.5_21-24 + M62.5_30-32" ~ "(M62.5g ET + Herbicide) | M62.5g SE",
    term == "pgr_trt_nameM62.5_21-24 + M62.5_37" ~ "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)",
    term == "pgr_trt_nameM62.5_30-32" ~ "M62.5g SE",
    term == "pgr_trt_nameM62.5_30-32 + M62.5_37" ~ "M62.5g SE | (M62.5g FLE + Fungicide)",
    term == "pgr_trt_nameM62.5_37" ~ "M62.5g Flag LE + Fungicide",
    TRUE ~ term
  )) 


```


```{r}
# Define custom order for PGR treatments
custom_order <- c("M62.5g SE | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | M62.5g SE", 
                  "M125g Flag LE + Fungicide",
                  "M125g SE",
                  "M62.5g Flag LE + Fungicide",
                  "M62.5g SE",
                  "M62.5g ET")

# Apply manual order to the "term" column for PGR treatments only
model_results_height <- model_results_height %>%
  mutate(term = fct_relevel(term, custom_order))

# Plot with reordered PGR treatments
ggplot(model_results_height, aes(x = estimate, y = term, shape = effect, color = significant_or_not)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = ci_lower, xmax = ci_upper), height = 0.2) +  # Confidence intervals
  geom_text(aes(label = paste(round(estimate, 2), p_signif)), hjust = 0.9, vjust = -0.8, size = 3, fontface = "bold", show.legend = F) +  # Add estimate & p-value stars
  facet_grid(category ~., scales = "free_y", space = "free_y") +  # Group by category
  geom_vline(xintercept = 0, lwd = 0.2, linetype = "dashed") +  # Vertical line at zero
  scale_shape_manual(values = c(16, 17)) +  # Different shapes for fixed and random effects
  scale_color_manual(values = c("gray60", "gray10", "green4")) +   # Different colors for fixed and random
  labs(title = "", caption = "Protein Content Mixed Model Effects with Confidence Intervals",
       x = "Estimated Effect", y = "",
       shape = "Effect Type", color = "P.Value") +
  theme_bw() +
  guides(color = "none") +
  theme(strip.text.y = element_text(angle = 0))+
  coord_cartesian(xlim = c(-0.8, 0.8))

ggsave("figure/Protein/protein_modeling.png", width = 8, height = 5, dpi = 600)
```
