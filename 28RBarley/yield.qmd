---
title: "Untitled"
format: html
editor: visual
---

# Data exploration

```{r}
data %>% 
  ggplot(aes(yield_adj_to_13_5_percent))+
  geom_histogram(bins = 100)
```

```{r}
data %>% 
  ggplot(aes(yield_adj_to_13_5_percent, fill = location))+
  geom_histogram(bins = 100)
```

```{r}
data %>% 
  ggplot(aes(yield_adj_to_13_5_percent, fill = location))+
  geom_histogram(bins = 100)+
  #geom_density(aes(alpha = 0.3))+
  facet_wrap(location ~ year)
```

```{r}
data %>% 
  ggplot(aes(yield_adj_to_13_5_percent, fill = location))+
  geom_histogram(bins = 100)+
  #geom_density(aes(alpha = 0.3))+
  facet_grid(location ~ year, scales = "free")
```

```{r}
data %>% 
  filter(location == "Vermilion") %>% 
  group_by(cultivar, year, pgr_trt_name) %>% 
  summarise(avg_r = mean(yield_adj_to_13_5_percent, na.rm = TRUE),
            sd_r = sd(yield_adj_to_13_5_percent, na.rm = TRUE)) %>% 
  ggplot(aes(year, avg_r, color = cultivar))+
  facet_wrap(vars(pgr_trt_name))+
  geom_point(position = position_dodge(width = 0.5))+
  geom_line(position = position_dodge(width = 0.5))+
  geom_errorbar(aes(ymin = avg_r - sd_r, ymax = avg_r + sd_r), width = 0.1,
                  position = position_dodge(width = 0.5))+
  scale_x_continuous(breaks = seq(2022, 2024,1))+
  labs(x = "Year", y = "Yield (kg/ha)")+
  theme_bw()

```

```{r}
p <- data %>% 
ggpubr::ggline(x = "year", y = "yield_adj_to_13_5_percent",
                    add = "mean_sd", color  = "cultivar", facet.by = "location",
               ylim = c(0,16000)) +
  theme_bw()
p
```

## Mixed modeling

```{r}
# Set a random seed for reproducibility
set.seed(123)

# Fit the mixed model with year & location as random effects
reg_mod <- lmer(yield_adj_to_13_5_percent ~ cultivar + pgr_trt_name + 
                (1 | year) + (1 | location), 
                data = data %>% mutate(pgr_trt_name = fct_relevel(pgr_trt_name, "No_PGR"),
                                       cultivar = fct_relevel(cultivar, "CDC_Austenson")))

# Extract fixed effects with p-values
fixed_effects <- broom.mixed::tidy(reg_mod, effects = "fixed") %>%
  filter(term != "(Intercept)")

# Extract confidence intervals for fixed effects
conf_int <- confint(reg_mod, method = "Wald") %>%  # Compute 95% CIs
  as.data.frame() %>%
  rownames_to_column("term") %>%
  filter(term %in% fixed_effects$term) %>%
  rename(ci_lower = `2.5 %`, ci_upper = `97.5 %`)

# Merge CIs with fixed effects
fixed_effects <- fixed_effects %>%
  left_join(conf_int, by = "term") %>%
  mutate(
    p_signif = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE ~ ""
    )
  )

# Extract random effects (variance components) - No p-values here
random_effects <- broom.mixed::tidy(reg_mod, effects = "ran_pars") %>%
  select(-term) %>% 
  rename(term = group) %>% 
  mutate(
    term = str_replace(term, "sd__", ""),  # Clean term names
    effect = "Random",
    p_signif = "",  # No p-values for random effects
    ci_lower = NA,  # No CIs for random effects
    ci_upper = NA
  )

# Combine fixed and random effects
model_results <- bind_rows(fixed_effects, random_effects)

# Assign grouping categories
model_results <- model_results %>%
  filter(term != "Residual") %>%
  mutate(category = case_when(
    grepl("location", term) ~ "Location",
    grepl("year", term) ~ "Year",
    grepl("cultivar", term) ~ "Cultivar",
    grepl("pgr_trt_name", term) ~ "PGR Treatment",
    TRUE ~ "Other"
  )) %>% 
  mutate(category = fct_relevel(category, "Location", "Year"),  # Convert to factor for correct order
         significant_or_not = case_when(p.value < 0.05 ~ "Significant",
                                        p.value >= 0.05 ~ "Not Significant",
                                        .default = "other"
           
         )) %>% 
  mutate(term = case_when(
    grepl("CDC_Austenson", term) ~ "CDC Austenson",
    grepl("cultivarAB_Hague", term) ~ "AB Hague",
    grepl("Esma", term) ~ "Esma",
   # grepl("TR18647", term) ~ "TR18647",
    grepl("M125_30-32", term) ~ "M125g SE",
    grepl("M125_37", term) ~ "M125g Flag LE + Fungicide",
    term == "pgr_trt_nameM62.5_21-24" ~ "M62.5g ET",
    term == "pgr_trt_nameM62.5_21-24 + M62.5_30-32" ~ "(M62.5g ET + Herbicide) | M62.5g SE",
    term == "pgr_trt_nameM62.5_21-24 + M62.5_37" ~ "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)",
    term == "pgr_trt_nameM62.5_30-32" ~ "M62.5g SE",
    term == "pgr_trt_nameM62.5_30-32 + M62.5_37" ~ "M62.5g SE | (M62.5g FLE + Fungicide)",
    term == "pgr_trt_nameM62.5_37" ~ "M62.5g Flag LE + Fungicide",
    TRUE ~ term
  )) 


```

```{r}
# Define custom order for PGR treatments
custom_order <- c("M62.5g SE | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | M62.5g SE", 
                  "M125g Flag LE + Fungicide",
                  "M125g SE",
                  "M62.5g Flag LE + Fungicide",
                  "M62.5g SE",
                  "M62.5g ET")

# Apply manual order to the "term" column for PGR treatments only
model_results <- model_results %>%
  mutate(term = fct_relevel(term, custom_order))
# Plot with significance stars and confidence intervals
ggplot(model_results, aes(x = estimate, y = term, shape = effect, color = significant_or_not)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(xmin = ci_lower, xmax = ci_upper), height = 0.2) +  # Confidence intervals
  geom_text(aes(label = paste(round(estimate, 1), p_signif)), hjust = 0.9, vjust = -0.8, size = 3, fontface = "bold", show.legend = F) +  # Add estimate & p-value stars
  facet_grid(category ~., scales = "free_y", space = "free_y") +  # Group by category
  geom_vline(xintercept = 0, lwd = 0.2, linetype = "dashed") +  # Vertical line at zero
  scale_shape_manual(values = c(16, 17)) +  # Different shapes for fixed and random effects
  scale_color_manual(values = c("gray60", "gray10", "green4")) +  # Different colors for fixed and random
  labs(title = "",
       x = "Estimated Effect (kg/ha)", y = "", caption = "Yield Mixed Model Effects with Confidence Intervals",
       shape = "Effect Type", color = "P.Value") +
  coord_cartesian(xlim = c(-1500, 3200))+
  theme_bw()+
  guides(color = "none")+
  #theme_minimal() +
  theme(strip.text.y = element_text(angle = 0))
ggsave("figure/yield/Yield_mixed_modeling.png", width = 8, height = 5, dpi = 600)
```

```{r}
#library(ggplot2)
#library(lme4)
# Extract residuals
residuals <- resid(reg_mod)

# Histogram of residuals
ggplot(data.frame(residuals), aes(x = residuals)) +
  geom_histogram(bins = 100, fill = "blue", alpha = 0.5, color = "black") +
  theme_minimal() +
  labs(title = "Histogram of Residuals", x = "Residuals", y = "Frequency")

```

```{r}
qqnorm(residuals)
qqline(residuals, col = "red")

```

```{r}
sjPlot::tab_model(reg_mod)
```

```{r}
ggplot(data.frame(Fitted = fitted(reg_mod), Residuals = residuals), 
       aes(x = Fitted, y = Residuals)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values", x = "Fitted Values", y = "Residuals")

```

```{r}
library(MuMIn)
r.squaredGLMM(reg_mod)
```

```{r}
reg_mod <- lmer(yield_adj_to_13_5_percent ~ cultivar + pgr_trt_name + 
                (1 | year) + (1 | location), 
                data = data %>% mutate(pgr_trt_name = fct_relevel(pgr_trt_name, "No_PGR"),
                                       cultivar = fct_relevel(cultivar, "Esma")))

data_clean <- data %>%
  filter(!is.na(cultivar), !is.na(pgr_trt_name), !is.na(year), !is.na(location))

# Predict using the cleaned dataset
data_pred <- data_clean %>%
  mutate(predicted_yield = predict(reg_mod, newdata = data_clean, re.form = NULL))

# Check result
data_pred

```

```{r}
data_stat <- data_pred %>% 
mutate(pgr_trt_name = case_when(
    pgr_trt_name == "M125_30-32" ~ "M125g SE",
    pgr_trt_name == "M125_37" ~ "M125g Flag LE + Fungicide",
    pgr_trt_name == "M62.5_21-24" ~ "M62.5g ET",
    pgr_trt_name == "M62.5_21-24 + M62.5_30-32" ~ "(M62.5g ET + Herbicide) | M62.5g SE",
    pgr_trt_name == "M62.5_21-24 + M62.5_37" ~ "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)",
    pgr_trt_name == "M62.5_30-32" ~ "M62.5g SE",
    pgr_trt_name == "M62.5_30-32 + M62.5_37" ~ "M62.5g SE | (M62.5g FLE + Fungicide)",
    pgr_trt_name == "M62.5_37" ~ "M62.5g Flag LE + Fungicide",
    .default =  pgr_trt_name
  )) 
```

## Varity per location, Yield

```{r}
source("myFunctions.R")
p1_1 <- lsd_test_02_mod(data_stat %>% 
              filter(location == "Vermilion") %>% 
              mutate(treatment = factor(year),
                     outcome = yield_adj_to_13_5_percent,
                     group = cultivar))+
  coord_cartesian(ylim = c(0,10000)) +
 theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (kg/ha)", title = "Vermilion", fill = "Variety")
p1_1
ggsave("figure/yield/Yield_Vermilion_year.png", width = 10, height = 5, dpi = 600)
```

```{r}
source("myFunctions.R")
p_av <- lsd_test_01_mod(data_stat %>% 
            #  filter(location == "Lethbridge") %>% 
              mutate(treatment = cultivar,
                     outcome = yield_adj_to_13_5_percent))+
  coord_cartesian(ylim = c(0,10000)) +
 theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
   labs(y= "Yield (kg/ha)", x = "", title = "Overall Average")
p_av
ggsave("figure/yield/Overall_Average.png", width = 10, height = 5, dpi = 600)
```

```{r}
source("myFunctions.R")
reshuffle <- c("M62.5g SE | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)", 
               "(M62.5g ET + Herbicide) | M62.5g SE", 
                  "M125g Flag LE + Fungicide",
                  "M125g SE",
                  "M62.5g Flag LE + Fungicide",
                  "M62.5g SE",
                  "M62.5g ET")

p_Ov <- lsd_test_01(data_stat %>% 
            #  filter(location == "Lethbridge") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = yield_adj_to_13_5_percent))+
  ylim(0,10000) +
 theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(y= "Yield (kg/ha)", x = "", title = "Overall Average")+
  coord_flip()
p_Ov
ggsave("figure/yield/Overall_trt.png", width = 10, height = 5, dpi = 600)
```

```{r}
p2 <- lsd_test_01(data_stat %>% 
              filter(location == "Lethbridge") %>% 
              mutate(treatment = cultivar,
                     outcome = yield_adj_to_13_5_percent))+
  coord_cartesian(ylim = c(0,14000)) +
  labs(x= "", y = "", title = "Lethbridge")+
 theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5,
    angle = 15)) +labs(x = NULL, y = NULL)
p2
```

```{r}
p2_1 <- lsd_test_02(data_stat %>% 
              filter(location == "Lethbridge") %>% 
              mutate(treatment = factor(year),
                     outcome = yield_adj_to_13_5_percent,
                     group = cultivar))+
  coord_cartesian(ylim = c(0,14000)) +
  labs(x= "", y = "", title = "Lethbridge")+
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (kg/ha)", title = "Lethbridge", fill = "Variety")
p2_1
ggsave("figure/yield/Yield_Lethbridge_year.png", width = 10, height = 5, dpi = 600)
```

```{r}
p3 <- lsd_test_01(data_stat %>% 
              filter(location == "Falher") %>% 
              mutate(treatment = cultivar,
                     outcome = yield_adj_to_13_5_percent))+
  coord_cartesian(ylim = c(0,8000))+
  labs(x= "", y = "", title = "Falher")+
   theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5,
    angle = 15)) +labs(x = NULL, y = NULL)
p3
```

```{r}
p3_1 <- lsd_test_02(data_stat %>% 
              filter(location == "Falher") %>% 
              mutate(treatment = factor(year),
                     outcome = yield_adj_to_13_5_percent,
                     group = cultivar))+
  coord_cartesian(ylim = c(0,10000)) +
  labs(x= "", y = "", title = "Falher")+
 theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (kg/ha)", title = "Falher", fill = "Variety")
p3_1
ggsave("figure/yield/Yield_Falher_year.png", width = 10, height = 5, dpi = 600)
```

```{r}
p1 + p3 + p2
ggsave("figure/yield/Yield_varietyy_locations.png", width = 8, height = 5, dpi = 600)
```

## Treatments

```{r}
source("myFunctions.R") 

p4 <- lsd_test_01(data_stat %>% 
              filter(location == "Vermilion") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = yield_adj_to_13_5_percent))+
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5#, size= 5, angle = 90
    )) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Vermilion")+
  ylim(0,12000)+
  coord_flip()
p4
ggsave("figure/yield/Yield_vermilion_trt.png", width = 8, height = 5, dpi = 600)
```

```{r}
data_stat <- data_pred %>% 
mutate(pgr_trt_name = case_when(
    pgr_trt_name == "M125_30-32" ~ "M125g SE",
    pgr_trt_name == "M125_37" ~ "M125g Flag LE + Fungicide",
    pgr_trt_name == "M62.5_21-24" ~ "M62.5g ET",
    pgr_trt_name == "M62.5_21-24 + M62.5_30-32" ~ "(M62.5g ET + Herbicide) | M62.5g SE",
    pgr_trt_name == "M62.5_21-24 + M62.5_37" ~ "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)",
    pgr_trt_name == "M62.5_30-32" ~ "M62.5g SE",
    pgr_trt_name == "M62.5_30-32 + M62.5_37" ~ "M62.5g SE | (M62.5g FLE + Fungicide)",
    pgr_trt_name == "M62.5_37" ~ "M62.5g Flag LE + Fungicide",
    .default =  pgr_trt_name
  )) 
```

```{r}
source("myFunctions.R")
reshuffle <- c("M62.5g SE | (M62.5g FLE + Fungicide)", 
                  "(M62.5g ET + Herbicide) | (M62.5g FLE + Fungicide)", 
               "(M62.5g ET + Herbicide) | M62.5g SE", 
                  "M125g Flag LE + Fungicide",
                  "M125g SE",
                  "M62.5g Flag LE + Fungicide",
                  "M62.5g SE",
                  "M62.5g ET")

p4_1 <- lsd_test_02(data_stat %>% 
              filter(location == "Vermilion") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = yield_adj_to_13_5_percent,
                     group = as.factor(year)))+
  ylim(0,12000) +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Vermilion", fill = "Year")+
   coord_flip()
p4_1
ggsave("figure/yield/Yield_vermilion_trt_year.png", width = 10, height = 8, dpi = 600)
```

```{r}
source("myFunctions.R")
p5 <- lsd_test_01(data_stat %>% 
              filter(location == "Lethbridge") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = yield_adj_to_13_5_percent))+
  ylim(0,14000) +
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
    axis.text.x = element_text(vjust = 0.5)) +
  labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Lethbridge")+
   coord_flip()
p5
ggsave("figure/yield/Yield_lethbridge_trt.png", width = 8, height = 5, dpi = 600)
```

```{r}
p5_1 <- lsd_test_02(data_stat %>% 
              filter(location == "Lethbridge") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = yield_adj_to_13_5_percent,
                     group = as.factor(year)))+
  ylim(0,15000) +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Lethbridge", fill = "Year")+
  coord_flip()
p5_1
ggsave("figure/yield/Yield_Lethbridge_trt_year.png", width = 10, height = 5, dpi = 600)
```

```{r}
p6 <- lsd_test_01(data_stat %>% 
              filter(location == "Falher") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = yield_adj_to_13_5_percent))+
   ylim(0,9000) +
  coord_flip()+
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Falher")
p6
ggsave("figure/yield/Yield_falher_trt.png", width = 8, height = 5, dpi = 600)
```

```{r}
p4 + p5 + p6
ggsave("figure/yield/Yield_all_location.png", width = 10, height = 5, dpi = 600)
```

```{r}
p6_1 <- lsd_test_02(data_stat %>% 
              filter(location == "Falher") %>% 
              mutate(treatment = fct_relevel(pgr_trt_name, reshuffle),
                     outcome = yield_adj_to_13_5_percent,
                     group = as.factor(year)))+
  ylim(0,8000) +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(vjust = 0.5)) +labs(x = NULL, y = NULL)+
  labs(x= "", y = "Yield (Kg/ha)", title = "Falher", fill = "Year")+
  coord_flip()
p6_1
ggsave("figure/yield/Yield_Falher_trt_year.png", width = 10, height = 5, dpi = 600)
```
